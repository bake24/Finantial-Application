# Описание функциональности приложения

## 🔐 Авторизация (без регистрации)

### Общее описание

Система авторизации реализована без функции самостоятельной регистрации новых пользователей. Предполагается, что учетные записи создаются администрацией или существуют изначально.

### Реализация

#### 1. Страница входа (`/login`)

**Компонент**: `LoginForm`  
**Расположение**: `src/features/auth/ui/LoginForm.tsx`

**Функциональность**:
- ✅ Форма ввода учетных данных (логин/имя пользователя и пароль)
- ✅ Валидация на стороне клиента перед отправкой
- ✅ Проверка данных через API запрос
- ✅ Отображение ошибок при неверных данных
- ✅ Индикатор загрузки во время проверки
- ✅ Перенаправление на `/dashboard` при успешной авторизации

**Поля формы**:
```typescript
- username: string (имя пользователя)
- password: string (пароль, минимум 6 символов)
```

#### 2. Механизм сессии

**Технология**: JWT токены + localStorage

**Процесс авторизации**:

1. **Отправка данных**:
   ```typescript
   POST /api/auth
   Body: { username, password }
   ```

2. **Ответ сервера**:
   ```typescript
   {
     user: {
       id: string,
       username: string,
       email?: string,
       createdAt: Date
     },
     token: string // JWT токен
   }
   ```

3. **Сохранение сессии**:
   - JWT токен сохраняется в `localStorage` (`btc_loan_auth_token`)
   - Данные пользователя сохраняются в `localStorage` (`btc_loan_user`)
   - Состояние пользователя сохраняется в Zustand store

4. **Восстановление сессии**:
   - При загрузке приложения (`_app.tsx`) проверяется наличие сохраненных данных
   - Если токен существует, пользователь автоматически авторизуется
   - Сессия сохраняется между перезагрузками страницы

#### 3. Защита маршрутов

**Компонент**: `ProtectedRoute`  
**Расположение**: `src/shared/lib/components/ProtectedRoute.tsx`

**Защищенные страницы**:
- `/dashboard` - личный кабинет
- `/loan` - оформление займа

**Поведение**:
- Неавторизованные пользователи перенаправляются на `/login`
- Показывается индикатор загрузки при проверке авторизации
- Авторизованные пользователи на `/login` перенаправляются на `/dashboard`

#### 4. Выход из системы

**Функция**: `logout()`

**Действия при выходе**:
- Удаление JWT токена из localStorage
- Удаление данных пользователя из localStorage
- Очистка глобального состояния Zustand
- Перенаправление на страницу входа

#### 5. Демо-данные для тестирования

```
Логин: demo
Пароль: demo123
```

### API Endpoint (Mock)

**Файл**: `src/pages/api/auth.ts`

```typescript
POST /api/auth
Request: {
  username: string,
  password: string
}

Success Response (200):
{
  user: User,
  token: string
}

Error Response (401):
{
  error: "Неверные учетные данные"
}
```

### Хуки для работы с авторизацией

**Файл**: `src/shared/lib/hooks/useAuth.ts`

```typescript
// Защита страницы авторизацией
const { isAuthenticated, user } = useAuth({
  redirectTo: '/login',
  redirectIfFound: false
});
```

---

## 💰 Оформление займа (форма, ограничения)

### Общее описание

Страница оформления Bitcoin-займа с формой заявки, валидацией ограничений и динамическим расчетом параметров кредита.

### Реализация

#### 1. Страница займа (`/loan`)

**Компонент**: `LoanForm`  
**Расположение**: `src/features/loan-application/ui/LoanForm.tsx`

**Функциональность**:
- ✅ Ввод суммы займа в BTC (с точностью до сатоши)
- ✅ Выбор срока кредитования с помощью слайдера
- ✅ Валидация ограничений в реальном времени
- ✅ Динамический расчет ежемесячного платежа
- ✅ Предварительный просмотр условий займа
- ✅ Отправка заявки на сервер
- ✅ Отображение ошибок валидации
- ✅ Перенаправление в Dashboard после успешного оформления

#### 2. Поля формы

**Сумма займа (BTC)**:
```typescript
type: number
step: 0.00000001 (точность до сатоши)
min: 0.01 BTC
max: 1 BTC
required: true
```

**Характеристики**:
- Поле ввода с числовым типом
- Плейсхолдер: "Например: 0.5"
- Подсказка: "Введите сумму от 0.01 до 1 BTC"
- Отображение ошибок валидации под полем

**Срок займа (месяцы)**:
```typescript
type: range (слайдер)
min: 1 месяц
max: 24 месяца
default: 12 месяцев
```

**Характеристики**:
- Визуальный слайдер для удобного выбора
- Отображение выбранного значения над слайдером
- Метки минимального и максимального значения

#### 3. Валидация ограничений

**Правила валидации**:

1. **Сумма займа**:
   - ✅ Должна быть числом > 0
   - ✅ Минимум: 0.01 BTC
   - ✅ Максимум: 1 BTC
   - ❌ Ошибка: "Сумма должна быть от 0.01 до 1 BTC"

2. **Срок займа**:
   - ✅ Должен быть целым числом
   - ✅ Минимум: 1 месяц
   - ✅ Максимум: 24 месяца
   - ❌ Ошибка: "Срок должен быть от 1 до 24 месяцев"

**Файл валидации**: `src/shared/lib/utils/validation.ts`

```typescript
// Валидация суммы
validateLoanAmount(amount: number): ValidationResult

// Валидация срока
validateLoanTerm(months: number): ValidationResult
```

#### 4. Динамический расчет параметров

**Отображается в реальном времени при изменении полей:**

```
┌─────────────────────────────────────────┐
│  📊 Расчет параметров займа             │
├─────────────────────────────────────────┤
│  Ежемесячный платеж:     0.XXXXXXXX BTC │
│  Общая сумма выплат:     0.XXXXXXXX BTC │
│  Процентная ставка:              5.0% годовых │
│  Переплата:              0.XXXXXXXX BTC │
├─────────────────────────────────────────┤
│  💡 Расчет обновляется автоматически    │
└─────────────────────────────────────────┘
```

**Формула расчета**: Аннуитетные платежи

```typescript
P = (S × r × (1 + r)^n) / ((1 + r)^n - 1)

где:
P - ежемесячный платеж
S - сумма займа
r - месячная процентная ставка (5% годовых / 12)
n - количество месяцев
```

**Файл с расчетами**: `src/shared/lib/utils/calculations.ts`

```typescript
// Расчет ежемесячного платежа
calculateMonthlyPayment(principal: number, months: number): number

// Расчет общей суммы выплат
calculateTotalPayment(principal: number, months: number): number

// Полный график платежей
calculatePaymentSchedule(principal: number, months: number): PaymentScheduleItem[]
```

#### 5. Процесс оформления займа

**Пошаговый процесс**:

1. **Ввод данных**:
   - Пользователь вводит сумму займа
   - Выбирает срок с помощью слайдера
   - Видит динамически обновляемый расчет

2. **Валидация**:
   - Проверка ограничений на клиенте
   - Отображение ошибок под полями
   - Кнопка "Оформить займ" активна только при валидных данных

3. **Отправка заявки**:
   ```typescript
   POST /api/loans
   Body: {
     amount: number,  // в BTC
     term: number     // в месяцах
   }
   ```

4. **Ответ сервера**:
   ```typescript
   {
     loan: {
       id: string,
       amount: number,
       term: number,
       monthlyPayment: number,
       totalPayment: number,
       remainingBalance: number,
       status: 'active',
       // ... другие поля
     },
     message: "Займ успешно оформлен"
   }
   ```

5. **После успешного оформления**:
   - Займ сохраняется в Zustand store
   - Перенаправление на `/dashboard`
   - Отображение полной информации о займе
   - Доступен график платежей

#### 6. Состояния формы

**Индикация состояний**:
- ⏳ **Загрузка**: Отключены поля, показана анимация на кнопке
- ✅ **Валидные данные**: Кнопка активна, показан расчет
- ❌ **Ошибки**: Красные сообщения под полями
- 🔄 **Динамический расчет**: Обновление при каждом изменении

#### 7. UI/UX особенности

**Удобство использования**:
- 🎨 Красивая карточка с градиентом для расчета
- 📊 Визуальные иконки для секций
- 🎚️ Слайдер для интуитивного выбора срока
- ✨ Плавные анимации и переходы
- 📱 Responsive дизайн для мобильных устройств
- 🔢 Точность до сатоши (8 знаков после запятой)

**Кнопки**:
- "Назад" - возврат на предыдущую страницу
- "Оформить займ" - отправка заявки (активна только при валидных данных)

#### 8. Обработка ошибок

**Типы ошибок**:

1. **Ошибки валидации**:
   - Отображаются под соответствующими полями
   - Красный цвет текста и border
   - Не позволяют отправить форму

2. **Ошибки сервера**:
   - Отображаются над кнопками
   - Сообщение об ошибке создания займа
   - Возможность повторной попытки

3. **Сетевые ошибки**:
   - Обработка через try-catch
   - Понятное сообщение пользователю

### API Endpoint (Mock)

**Файл**: `src/pages/api/loans.ts`

```typescript
POST /api/loans
Request: {
  amount: number,  // 0.01 - 1 BTC
  term: number     // 1 - 24 месяцев
}

Success Response (200):
{
  loan: Loan,
  message: "Займ успешно оформлен"
}

Error Response (400):
{
  error: "Некорректные параметры займа"
}
```

### Константы приложения

**Файл**: `src/shared/config/constants.ts`

```typescript
export const APP_CONFIG = {
  MAX_LOAN_BTC: 1,           // Максимальная сумма займа
  MAX_LOAN_MONTHS: 24,       // Максимальный срок
  MIN_LOAN_BTC: 0.01,        // Минимальная сумма займа
  MIN_LOAN_MONTHS: 1,        // Минимальный срок
  INTEREST_RATE: 0.05,       // Процентная ставка (5%)
};
```

---

---

## 📊 График платежей (расчёт, визуализация)

### Общее описание

График платежей формируется автоматически на основе суммы займа и срока кредитования. Используется метод **аннуитетных платежей**, при котором ежемесячный платеж остается постоянным, но меняется соотношение между основным долгом и процентами.

### Реализация

#### 1. Расчёт графика платежей

**Файл**: `src/shared/lib/utils/calculations.ts`

**Метод расчета**: Аннуитетные платежи

**Формула**:
```
P = S × [r × (1 + r)^n] / [(1 + r)^n - 1]

где:
P - ежемесячный платеж
S - сумма займа (principal)
r - месячная процентная ставка (5% годовых / 12 = 0.004167)
n - количество месяцев
```

**Пример расчета**:
```typescript
// Займ 1 BTC на 12 месяцев под 5% годовых
const schedule = calculatePaymentSchedule(1, 12);

// Результат:
// Ежемесячный платеж: ~0.08774 BTC
// Общая сумма выплат: ~1.05293 BTC  
// Переплата: ~0.05293 BTC
```

**Структура платежа**:

Каждый элемент графика содержит:
- `month` - номер месяца (1, 2, 3...)
- `date` - дата платежа
- `payment` - общая сумма платежа (постоянная)
- `principal` - часть основного долга (растёт)
- `interest` - часть процентов (уменьшается)
- `remainingBalance` - остаток долга

**Динамика платежей**:
```
Месяц 1:  Проценты: 0.00417 BTC | Основной долг: 0.08357 BTC
Месяц 6:  Проценты: 0.00208 BTC | Основной долг: 0.08566 BTC
Месяц 12: Проценты: 0.00037 BTC | Основной долг: 0.08737 BTC
```

#### 2. Табличное представление (PaymentSchedule)

**Компонент**: `PaymentSchedule`  
**Расположение**: `src/widgets/PaymentSchedule/ui/PaymentSchedule.tsx`

**Функциональность**:
- ✅ Полный список всех платежей по месяцам
- ✅ Детализация каждого платежа (основной долг + проценты)
- ✅ Отображение остатка долга после каждого платежа
- ✅ Визуальное выделение оплаченных месяцев (зеленый фон)
- ✅ Подсветка текущего платежа (оранжевый фон)
- ✅ Адаптивная таблица с горизонтальной прокруткой

**Колонки таблицы**:

| Колонка | Описание | Пример |
|---------|----------|--------|
| **Месяц** | Порядковый номер + статус (✓ или →) | "1 →" |
| **Дата** | Дата платежа | "16.11.2024" |
| **Платеж** | Общая сумма ежемесячного платежа | "0.08774161 BTC" |
| **Основной долг** | Часть, идущая на погашение займа | "0.08357161 BTC" |
| **Проценты** | Часть в виде процентов | "0.00417000 BTC" |
| **Остаток** | Задолженность после платежа | "0.91642839 BTC" |

**Цветовая индикация**:
- 🟢 **Зеленый фон** - оплаченный месяц (✓)
- 🟠 **Оранжевый фон** - текущий месяц (→)
- ⚪ **Белый фон** - предстоящие платежи

#### 3. Графическая визуализация (ScheduleChart)

**Компонент**: `ScheduleChart`  
**Расположение**: `src/widgets/ScheduleChart/ui/ScheduleChart.tsx`  
**Библиотека**: Recharts

**Функциональность**:
- ✅ Линейный график динамики погашения займа
- ✅ Три линии данных для наглядности
- ✅ Интерактивные подсказки (Tooltip) при наведении
- ✅ Автоматическое масштабирование осей
- ✅ Responsive дизайн

**Линии графика**:

1. **Остаток долга** (оранжевая, главная):
   - Показывает уменьшение задолженности
   - Начинается с полной суммы займа
   - Заканчивается на нуле
   - Stroke width: 3px (самая толстая)

2. **Основной долг** (зеленая):
   - Часть ежемесячного платежа на погашение
   - Постепенно увеличивается
   - В начале меньше, в конце больше

3. **Проценты** (красная):
   - Часть ежемесячного платежа в виде процентов
   - Постепенно уменьшается
   - В начале больше, в конце меньше

**Особенности визуализации**:
```
┌─────────────────────────────────────┐
│  BTC                                │
│  1.0 ┐                              │
│      │●                             │
│  0.8 │ ●                            │
│      │  ●  (Остаток долга)          │
│  0.6 │   ●                          │
│      │    ●                         │
│  0.4 │     ●                        │
│      │      ●                       │
│  0.2 │       ●●●●                   │
│      │           ●●●●●●●            │
│  0.0 └─┴─┴─┴─┴─┴─┴─┴─┴─┴─┴─┴──      │
│      1 2 3 4 5 6 7 8 9 10 11 12    │
│                    Месяц            │
└─────────────────────────────────────┘
```

#### 4. Интерактивность

**Tooltip (всплывающая подсказка)**:
При наведении на точку графика отображается:
```
Месяц 5
Остаток долга:    0.58214321 BTC
Основной долг:    0.08528921 BTC
Проценты:         0.00245240 BTC
```

**Легенда**:
- ■ Остаток долга (оранжевая)
- ■ Основной долг (зеленая)
- ■ Проценты (красная)

#### 5. Автоматический расчёт

**Когда формируется график**:
1. При создании нового займа на `/loan`
2. При загрузке данных займа в Dashboard
3. После частичного погашения (пересчёт остатка)

**Процесс**:
```typescript
// 1. Получаем параметры займа
const { amount, term, startDate } = loan;

// 2. Рассчитываем полный график
const schedule = calculatePaymentSchedule(amount, term, startDate);

// 3. Отображаем в таблице
<PaymentSchedule schedule={schedule} currentMonth={1} />

// 4. Отображаем в графике
<ScheduleChart schedule={schedule} />
```

---

## 🏠 Личный кабинет (Dashboard)

### Общее описание

Dashboard - главная страница авторизованного пользователя (`/dashboard`), центральное место управления займом. Отображает всю ключевую информацию, графики платежей и предоставляет доступ к основным действиям.

### Реализация

#### 1. Страница Dashboard

**Компонент**: `Dashboard`  
**Расположение**: `src/widgets/Dashboard/ui/Dashboard.tsx`  
**Маршрут**: `/dashboard`

**Защита**: Требует авторизации (редирект на `/login` для гостей)

#### 2. Структура Dashboard

```
┌──────────────────────────────────────────────────┐
│  📋 Информация о займе          [Активен]       │
├──────────────────────────────────────────────────┤
│  Сумма займа:       0.50000000 BTC              │
│  Остаток долга:     0.45821272 BTC              │
│  Ежемесячный:       0.04387061 BTC              │
│                                                  │
│  ████████████░░░░░░░░░ 8.4%                     │
│  Прогресс выплат                                │
│                                                  │
│  Срок: 12 мес. | Ставка: 5% | Выплачено: 8.4%  │
│                                                  │
│  [Досрочное погашение]                          │
├──────────────────────────────────────────────────┤
│  📈 Динамика погашения займа                    │
│  [ГРАФИК]                                       │
├──────────────────────────────────────────────────┤
│  📅 График платежей                             │
│  [ТАБЛИЦА]                                      │
└──────────────────────────────────────────────────┘
```

#### 3. Блоки Dashboard

**A. Карточка информации о займе**

Отображает:
- **Статус займа**: Активен / Завершен / Отменён
- **Дата оформления**: Когда был создан займ
- **Основные параметры**:
  - Сумма займа (выданная изначально)
  - Остаток долга (текущая задолженность)
  - Ежемесячный платеж (фиксированная сумма)

**Прогресс-бар выплат**:
```typescript
const progress = (totalPaid / amount) * 100;
```
- Визуальная индикация погашения долга
- Цвет: Bitcoin оранжевый (#f7931a)
- Процент выполнения

**Дополнительная информация**:
- Срок займа (в месяцах)
- Процентная ставка (5% годовых)
- Общая сумма выплат
- Выплачено на данный момент

**B. Динамика погашения (график)**

Интеграция компонента `ScheduleChart`:
```tsx
<ScheduleChart schedule={schedule} />
```

Показывает:
- Линейный график уменьшения долга
- Распределение платежей по месяцам
- Структуру платежей (основной долг vs проценты)

**C. График платежей (таблица)**

Интеграция компонента `PaymentSchedule`:
```tsx
<PaymentSchedule schedule={schedule} currentMonth={currentMonth} />
```

Показывает:
- Детальную таблицу всех платежей
- Подсветку текущего и оплаченных месяцев
- Разбивку платежа на составляющие

#### 4. Интерактивные действия

**Досрочное погашение**:
```tsx
<Button onClick={() => setIsRepaymentModalOpen(true)}>
  Досрочное погашение
</Button>
```

Открывает модальное окно `RepaymentModal` для:
- Частичного погашения (любая сумма до остатка)
- Полного погашения (закрытие займа)

**Выход из системы**:
```tsx
<Button variant="ghost" onClick={handleLogout}>
  Выйти
</Button>
```

#### 5. Обновление данных в реальном времени

**После досрочного погашения**:
1. Отправляется запрос на сервер
2. Получается обновленный остаток долга
3. Пересчитывается график платежей
4. Dashboard автоматически обновляется

```typescript
const handleLoanUpdate = () => {
  // Перезагрузка данных займа
  // Пересчёт графика
  // Обновление UI
};
```

#### 6. Состояния Dashboard

**Если займ активен**:
- ✅ Показана вся информация
- ✅ Доступно досрочное погашение
- ✅ Отображается прогресс

**Если займа нет**:
```tsx
<EmptyState 
  title="У вас нет активных займов"
  action="Оформить займ"
  onAction={() => router.push('/loan')}
/>
```

**Если займ завершён**:
- ✅ Статус "Завершен"
- ✅ История платежей доступна
- ❌ Досрочное погашение недоступно

#### 7. Responsive дизайн

**Desktop (1024px+)**:
- Информация в три колонки
- График и таблица рядом

**Tablet (768px-1024px)**:
- Информация в две колонки
- График и таблица друг под другом

**Mobile (< 768px)**:
- Одна колонка
- Компактное отображение данных
- Горизонтальная прокрутка таблицы

#### 8. Интеграция компонентов

**Иерархия**:
```
DashboardPage (страница)
  └── Dashboard (виджет)
      ├── Loan Info Card
      ├── ScheduleChart (виджет)
      ├── PaymentSchedule (виджет)
      └── RepaymentModal (feature)
```

**Передача данных**:
```typescript
// Получение займа из store
const { currentLoan } = useLoanStore();

// Расчет графика
const schedule = calculatePaymentSchedule(
  currentLoan.amount,
  currentLoan.term,
  currentLoan.startDate
);

// Передача в компоненты
<Dashboard loan={currentLoan} onLoanUpdate={handleUpdate} />
```

#### 9. Индикаторы и уведомления

**Ближайший платёж**:
```tsx
const nextPayment = schedule.find(p => p.month === currentMonth + 1);

<div className="bg-yellow-50 p-4 rounded-lg">
  <p>Следующий платеж: {formatDateShort(nextPayment.date)}</p>
  <p>Сумма: {formatBTC(nextPayment.payment)}</p>
</div>
```

**Офлайн-статус**:
```tsx
{!navigator.onLine && (
  <div className="bg-red-50 p-3 rounded">
    ⚠️ Нет подключения к интернету
  </div>
)}
```

---

## 💸 Частичное/досрочное погашение (модалки, обновление графика)

### Общее описание

Функциональность досрочного погашения позволяет пользователю уменьшить задолженность раньше установленного срока. Это может быть как частичное погашение (любая сумма), так и полное закрытие займа.

### Реализация

#### 1. Модальное окно RepaymentModal

**Компонент**: `RepaymentModal`  
**Расположение**: `src/features/repayment/ui/RepaymentModal.tsx`

**Открытие**: Кнопка "Досрочное погашение" в Dashboard

**Функциональность**:
- ✅ Ввод суммы погашения с точностью до сатоши
- ✅ Валидация (не больше остатка долга)
- ✅ Быстрое заполнение полной суммы одной кнопкой
- ✅ Предпросмотр эффекта погашения в реальном времени
- ✅ Визуальная индикация типа погашения (частичное/полное)
- ✅ Предупреждения и подсказки

#### 2. Интерфейс модального окна

```
┌──────────────────────────────────────────┐
│  Досрочное погашение              [✕]    │
├──────────────────────────────────────────┤
│                                          │
│  Текущий остаток долга:                  │
│  0.45821272 BTC         [Макс. сумма]    │
│                                          │
│  Сумма погашения (BTC) *                 │
│  ┌────────────────────────────────────┐  │
│  │ 0.1                                 │  │
│  └────────────────────────────────────┘  │
│  Введите сумму от 0.00000001 до ...     │
│                                          │
│  ┌────────────────────────────────────┐  │
│  │ ℹ️ → Частичное погашение           │  │
│  │ Сумма погашения: 0.10000000 BTC    │  │
│  │ Новый остаток:   0.35821272 BTC    │  │
│  │ 📊 График платежей будет пересчитан │  │
│  └────────────────────────────────────┘  │
│                                          │
│  [💰 Погасить полностью (0.45821272)]   │
│                                          │
│  ⚠️ Важно: После досрочного погашения   │
│  график платежей будет автоматически    │
│  пересчитан...                          │
│                                          │
│  [Отмена]        [Погасить частично]    │
│                                          │
└──────────────────────────────────────────┘
```

#### 3. Типы погашения

**A. Частичное погашение** (amount < remainingBalance)

```typescript
// Пример: остаток 0.5 BTC, погашаем 0.1 BTC
{
  loanId: "loan-123",
  amount: 0.1,
  type: "partial"
}

// Результат:
// - Новый остаток: 0.4 BTC
// - График пересчитывается с остатком 0.4 BTC
// - Может сократиться срок или уменьшиться платежи
```

**B. Полное погашение** (amount >= remainingBalance)

```typescript
// Пример: остаток 0.5 BTC, погашаем 0.5 BTC
{
  loanId: "loan-123",
  amount: 0.5,
  type: "full"
}

// Результат:
// - Займ закрывается
// - Остаток долга = 0
// - Статус меняется на "completed"
```

#### 4. Валидация суммы

**Правила валидации**:

```typescript
// Сумма должна быть положительной
if (amount <= 0) {
  error = "Сумма должна быть больше нуля";
}

// Сумма не должна превышать остаток долга
if (amount > remainingBalance) {
  error = "Сумма превышает остаток долга";
}

// Минимальная сумма: 1 сатоши
if (amount < 0.00000001) {
  error = "Минимальная сумма: 0.00000001 BTC";
}
```

**Файл**: `src/shared/lib/utils/validation.ts`

```typescript
export function validateRepaymentAmount(
  amount: number,
  remainingBalance: number
): ValidationResult {
  if (isNaN(amount) || amount <= 0) {
    return {
      isValid: false,
      error: 'Сумма должна быть положительным числом',
    };
  }

  if (amount > remainingBalance) {
    return {
      isValid: false,
      error: 'Сумма превышает остаток долга',
    };
  }

  return { isValid: true };
}
```

#### 5. Предпросмотр эффекта

**Динамический расчет в реальном времени**:

При вводе суммы автоматически рассчитывается:

```typescript
// Новый остаток после погашения
const newBalance = remainingBalance - amount;

// Тип погашения
const isFullRepayment = amount >= remainingBalance;

// Визуальная индикация:
// - Зеленый для полного погашения (✓)
// - Синий для частичного (→)
```

**Отображаемая информация**:
- Сумма погашения
- Новый остаток долга
- Тип операции (частичное/полное)
- Подсказка об обновлении графика

#### 6. Процесс погашения

**Пошаговый процесс**:

```
1. Пользователь открывает модалку
   ↓
2. Вводит сумму или нажимает "Погасить полностью"
   ↓
3. Видит предпросмотр эффекта
   ↓
4. Нажимает "Погасить частично" или "Закрыть займ"
   ↓
5. Отправляется POST /api/repayment
   ↓
6. Сервер обрабатывает погашение
   ↓
7. Возвращается новый остаток долга
   ↓
8. Вызывается onSuccess callback
   ↓
9. Dashboard обновляется с новыми данными
   ↓
10. График платежей пересчитывается
   ↓
11. Модалка закрывается
```

#### 7. Обновление графика платежей

**После частичного погашения**:

График платежей автоматически пересчитывается с учетом нового остатка долга.

**Варианты пересчета**:

**A. Сокращение срока** (предпочтительно):
```
До погашения:
- Остаток: 0.5 BTC
- Срок: 12 месяцев
- Платеж: 0.04387 BTC/мес

Погашение: 0.2 BTC

После погашения:
- Остаток: 0.3 BTC
- Срок: ~7 месяцев (сократился!)
- Платеж: 0.04387 BTC/мес (тот же)
```

**B. Уменьшение платежа** (альтернатива):
```
До погашения:
- Остаток: 0.5 BTC
- Срок: 12 месяцев
- Платеж: 0.04387 BTC/мес

Погашение: 0.2 BTC

После погашения:
- Остаток: 0.3 BTC
- Срок: 12 месяцев (тот же)
- Платеж: ~0.02632 BTC/мес (меньше!)
```

**Реализация в Dashboard**:

```typescript
const handleLoanUpdate = async () => {
  // 1. Перезагружаем данные займа с сервера
  const updatedLoan = await fetchLoan(loanId);
  
  // 2. Обновляем store
  setLoan(updatedLoan);
  
  // 3. График автоматически пересчитывается с новым остатком
  const newSchedule = calculatePaymentSchedule(
    updatedLoan.remainingBalance,  // Новый остаток!
    updatedLoan.term,
    updatedLoan.startDate
  );
  
  // 4. Компоненты re-render с новыми данными
};
```

#### 8. API Endpoint

**Файл**: `src/pages/api/repayment.ts`

```typescript
POST /api/repayment

Request:
{
  loanId: string,
  amount: number,        // Сумма в BTC
  type: 'partial' | 'full'
}

Success Response (200):
{
  success: true,
  newBalance: number,    // Новый остаток долга
  message: string
}

Error Response (400):
{
  error: "Некорректные параметры погашения"
}
```

**Логика на сервере** (mock):

```typescript
export default function handler(req, res) {
  const { loanId, amount, type } = req.body;
  
  // Получаем текущий займ
  const loan = getLoan(loanId);
  
  // Рассчитываем новый остаток
  const newBalance = type === 'full' 
    ? 0 
    : loan.remainingBalance - amount;
  
  // Обновляем займ в базе
  updateLoan(loanId, {
    remainingBalance: newBalance,
    status: newBalance === 0 ? 'completed' : 'active'
  });
  
  // Возвращаем результат
  return res.json({
    success: true,
    newBalance,
    message: type === 'full' 
      ? 'Займ погашен полностью' 
      : 'Частичное погашение выполнено'
  });
}
```

#### 9. UI/UX особенности

**Визуальные подсказки**:

- 🟢 **Зеленый блок** - полное погашение
  - Иконка галочки
  - Текст "Займ будет полностью закрыт"
  - Кнопка "Закрыть займ"

- 🔵 **Синий блок** - частичное погашение
  - Иконка информации
  - Текст "График будет пересчитан"
  - Кнопка "Погасить частично"

**Интерактивность**:

- Кнопка "Погасить полностью" - автозаполнение полной суммы
- Поле ввода с маской и валидацией
- Real-time предпросмотр результата
- Disabled кнопка отправки при невалидных данных

**Предупреждения**:

```
⚠️ Важно: После досрочного погашения график платежей 
будет автоматически пересчитан. В зависимости от суммы 
погашения может измениться срок займа или размер 
оставшихся платежей.
```

#### 10. Обновление Dashboard

**Что обновляется после погашения**:

1. **Остаток долга** - новое значение
2. **Прогресс-бар** - процент выплат увеличивается
3. **График (ScheduleChart)** - новая кривая погашения
4. **Таблица (PaymentSchedule)** - пересчитанные платежи
5. **Выплачено** - увеличивается на сумму погашения

**Пример обновления**:

```typescript
// До погашения
{
  amount: 0.5 BTC,
  remainingBalance: 0.5 BTC,
  totalPaid: 0 BTC,
  progress: 0%
}

// После погашения 0.2 BTC
{
  amount: 0.5 BTC,
  remainingBalance: 0.3 BTC,  // ← обновлено
  totalPaid: 0.2 BTC,         // ← обновлено
  progress: 40%               // ← обновлено
}
```

#### 11. Уведомления пользователя

**После успешного погашения**:

В реальном приложении можно добавить:
- Toast уведомление "Погашение выполнено успешно"
- Email подтверждение
- История транзакций
- Квитанция для скачивания

**Текущая реализация**:
- Модалка закрывается
- Dashboard обновляется автоматически
- Пользователь видит новые данные

#### 12. Состояния модалки

| Состояние | Описание | UI |
|-----------|----------|-----|
| **Idle** | Начальное | Пустое поле, кнопки активны |
| **Typing** | Ввод суммы | Предпросмотр обновляется |
| **Valid** | Валидная сумма | Зеленый/синий блок, кнопка активна |
| **Invalid** | Ошибка | Красное сообщение, кнопка disabled |
| **Loading** | Отправка | Spinner на кнопке, поля disabled |
| **Success** | Готово | Модалка закрывается |
| **Error** | Ошибка сервера | Красное сообщение об ошибке |

#### 13. Примеры использования

**Пример 1: Частичное погашение**

```
Исходные данные:
- Займ: 1 BTC на 12 месяцев
- Остаток: 0.8 BTC (прошло 3 месяца)
- Платеж: 0.08774 BTC/мес

Пользователь гасит: 0.3 BTC

Результат:
- Новый остаток: 0.5 BTC
- График пересчитывается на 0.5 BTC
- Осталось ~6 месяцев вместо 9
- Экономия на процентах!
```

**Пример 2: Полное погашение**

```
Исходные данные:
- Займ: 0.5 BTC на 12 месяцев
- Остаток: 0.2 BTC (прошло 8 месяцев)
- Платеж: 0.04387 BTC/мес

Пользователь гасит: 0.2 BTC (полностью)

Результат:
- Займ закрыт
- Статус: "Завершен"
- Нет больше платежей
- Сэкономлено на процентах за 4 месяца!
```

### Преимущества досрочного погашения

✅ **Экономия на процентах** - меньше переплата  
✅ **Гибкость** - можно гасить любую сумму  
✅ **Быстрое закрытие** - полное погашение в 1 клик  
✅ **Прозрачность** - виден эффект до подтверждения  
✅ **Автоматизация** - график пересчитывается сам  

---

## 🔒 Безопасность

### Текущая реализация (Mock)

⚠️ **Важно**: Текущая версия использует mock API для демонстрации.

### Для Production

**Необходимо реализовать**:
- ✅ Настоящую JWT аутентификацию
- ✅ HTTPS протокол
- ✅ Серверную валидацию данных
- ✅ CSRF защиту
- ✅ Rate limiting
- ✅ Secure cookies для токенов
- ✅ Input sanitization
- ✅ SQL injection защиту

---

## 📱 Responsive Design

Все компоненты адаптированы для:
- 📱 Мобильных устройств (320px+)
- 📱 Планшетов (768px+)
- 💻 Десктопов (1024px+)

---

## 🎯 Следующие шаги

После установки и запуска приложения:

1. Откройте http://localhost:3000
2. Перейдите на `/login`
3. Введите демо-данные (demo / demo123)
4. Оформите тестовый займ на `/loan`
5. Просмотрите детали в `/dashboard`

---

## 📚 Связанная документация

- [README.md](./README.md) - Общее описание проекта
- [ARCHITECTURE.md](./ARCHITECTURE.md) - Архитектура приложения
- [SETUP.md](./SETUP.md) - Инструкция по установке
- [API Documentation] - Описание API endpoints

